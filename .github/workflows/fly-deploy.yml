# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/
# 420 69

name: Fly Deploy

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy-node-server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: |
          export FLY_APP_NAME=${{ github.ref == 'refs/heads/main' && 'pixa-observe' || 'pixa-observe-staging' }}
          flyctl deploy --remote-only --app $FLY_APP_NAME --dockerfile apps/node-server/Dockerfile --config apps/node-server/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          HOST: 0.0.0.0
          PORT: 3003
          ENVIRONMENT: development
          DEBUG: true
          AWS_BUCKET_NAME: newmark
          AWS_BUCKET_REGION: us-east-1
          AUDIO_SERVICE_URL: ${{ github.ref == 'refs/heads/main' && 'https://fixa-transcription-service.fly.dev' || 'https://fixa-transcription-service-staging.fly.dev' }}
          SQS_QUEUE_URL: ${{ github.ref == 'refs/heads/main' && 'https://sqs.us-east-1.amazonaws.com/195275634305/fixa-observe-prod' || 'https://sqs.us-east-1.amazonaws.com/195275634305/fixa-observe-dev' }}
          GOOGLE_CLOUD_BUCKET_NAME: pixa-audio
          NODE_SERVER_URL: ${{ github.ref == 'refs/heads/main' && 'https://pixa-observe.fly.dev' || 'https://pixa-observe-staging.fly.dev' }}

  deploy-transcription-service:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: |
          export FLY_APP_NAME=${{ github.ref == 'refs/heads/main' && 'fixa-transcription-service' || 'fixa-transcription-service-staging' }}
          cd apps/transcription-service
          flyctl deploy --remote-only --app $FLY_APP_NAME
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
